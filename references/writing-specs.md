# 写入规范与模板

## 资产沉淀写入规范（必须遵守）

### 1) History：事件记录（建议分文件）
优先采用“分文件 + EVOLVE.md 索引”的方式：
- 新增文件：`evolve/history/YYYY-MM-DD-<topic>.md`
- EVOLVE.md 只追加索引项（摘要 + 链接）

事件记录模板：

### [YYYY-MM-DD] 标题
- 🎯 背景：
- 💡 技术要点：
- 🐛 问题与解决：
- ✅ 验收/验证：
- 🔒 风险与回滚：


### 2) Rules：规则必须“协议化”（可执行、可验收）

新增规则时，必须用以下模板表达（避免歧义）：

- [YYYY-MM-DD] **[分类] 规则编号/标题**
  - 触发：什么情况下适用
  - 必须：必须执行的步骤/检查点
  - 验收：如何确认完成（命令/现象/指标）
  - 禁止：明确禁止的捷径/高风险做法
  - 例外：允许跳过的条件（如有）


规则写入原则：

* **短而硬**：宁少勿滥；不产生复利的“建议”不要进入 Rules
* **去重合并**：新增内容与旧规则同主题时，应合并为一条更强的协议化规则
* **索引优先**：高频规则要在 TL;DR 或 Rules 顶部可见

**新增经验的 origin 与初始值**：

| 来源场景 | `origin` | 初始 `vio` | 初始 `err` | 说明 |
|---------|----------|-----------|-----------|------|
| 因错误/返工而新增 | `error` | `1` | `≥1`（视实际错误数） | 该经验的第一次记录本身就是一次违反 |
| 预防性新增（未出过错） | `preventive` | `0` | `0` | 纯预防，尚无违反记录 |
| 从外部导入的最佳实践 | `imported` | `0` | `0` | 团队规范或行业最佳实践 |

**平台标签（`platform`）写入规则**：

| 规则类型 | `platform` |
|---------|------------|
| 通用规则（`R-xxx`） | 固定 `all` |
| 平台教训（`S-xxx`） | 必须使用明确平台值（如 `claude` / `gemini` / `codex` / `cursor` / 自定义） |

> 目的：让 `audit_sync.py filter/score/promote --platform ...` 可以做平台解耦筛选，避免跨平台污染。

### 3) Runbooks：按任务写 Checklist

优先采用“分文件 + EVOLVE.md 索引”的方式：
- 新增文件：`evolve/runbooks/YYYY-MM-DD-<topic>.md`
- EVOLVE.md 只追加索引项（摘要 + 链接）

Runbook 的核心是“照做即可复现”，建议包含：

* 目标与前置条件
* 步骤（Checklist）
* 验收（必须有）
* 回滚方案（可选但推荐）

### 4) Changelog：变更注记

每次进化完成后，必须在 EVOLVE.md 的 Changelog 章节追加一条记录：

```markdown
### [YYYY-MM-DD] 变更注记
- 新增 Rules: （规则标题/编号）
- 更新 Runbook: （手册标题）
- 新增 History: （事件标题）
- 平台教训: （写入了哪个平台文件，如有）
```

**归档策略**：Changelog 保留在主文件中便于快速审计。当条目超过 **30 条**时，将最早的记录迁移至 `evolve/changelog-archive.md`，主文件只保留最近 10 条。

---

## 平台配置文件写入规范（仅平台特有）

1. 识别当前平台身份：

* Claude → `CLAUDE.md`
* Gemini → `GEMINI.md`
* Codex/其他 → `AGENTS.md`

2. 在目标文件查找或创建章节：
   `## 🧬 自我进化/经验教训`

追加模板：

- [YYYY-MM-DD] **[Self]**：平台特有的行为矫正/偏好（只写当前平台）


硬约束：

* 不得把通用规则复制到平台文件（通用只在 EVOLVE.md）
* 平台文件应保留 `EVOLVE_SKILL:AUTO_SYNC` 自动区块，作为 EVOLVE.md 的同步镜像入口（避免手工重复维护）

---

## 用户级晋升机制

当发现某条教训**不局限于当前项目，而是整个平台通用**时，应将其从项目级配置文件晋升到用户级配置文件。

**晋升路径**：

| 平台 | 项目级 | 用户级 |
|------|--------|--------|
| Claude | `<project>/CLAUDE.md` | `~/.claude/CLAUDE.md` |
| Gemini | `<project>/GEMINI.md` | `~/.gemini/GEMINI.md`（或对应全局配置） |
| Codex | `<project>/AGENTS.md` | `~/.codex/AGENTS.md`（或对应全局配置） |

**晋升判定条件**（满足任一即可）：
1. **跨项目复现**：同一教训在 2 个以上项目中被记录过
2. **平台级通病**：教训源于平台/模型本身的行为特征，与具体项目无关（如"Claude 倾向于过度使用某工具"）
3. **用户明确要求**：用户主动指示"这条提升为全局规则"

**晋升流程**：
1. 在用户级配置文件的 `## 🧬 自我进化/经验教训` 章节追加该条教训，并标注来源项目
2. 在原项目级配置文件中，将该条标记为 `[已晋升至用户级]`，保留原文不删除
3. 晋升操作需在 EVOLVE.md 的 Changelog 中记录

**晋升模板**（用户级配置文件）：
```markdown
- [YYYY-MM-DD] **[Self-Global]**：（教训内容）— 来源：<project-name>
```
